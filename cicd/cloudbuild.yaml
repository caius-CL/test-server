substitutions:
  # GCP ÈÖçÁΩÆ
  _REGION: "asia-east1"
  _REPO_NAME: "caius-test-repo"
  _SERVICE_NAME: "test-server"
  _CLUSTER_NAME: "temp-cluster-01"
  _ZONE_NAME: "asia-east1"
  
  # Kubernetes ÈÖçÁΩÆ
  _NAMESPACE_NAME: "test-server"
  _DEPLOYMENT_NAME: "test-server"
  _APP_LABEL: "test-server"
  _K8S_PATH: "test-project/test-server/k8s"
  
  # ÊáâÁî®Á®ãÂºèÈÖçÁΩÆ
  _CONTAINER_PORT: "8080"
  _SERVICE_PORT: "8080"
  _REPLICAS: "1"
  _MAX_SURGE: "25%"
  _MAX_UNAVAILABLE: "0"
  _INITIAL_DELAY_SECONDS: "10"
  _PERIOD_SECONDS: "10"
  
  # Ë®àÁÆóÁöÑËÆäÊï∏
  _IMAGE_PATH: ${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: "E2_HIGHCPU_8"
  diskSizeGb: "100"
timeout: "1800s"

steps:
# 1) Âª∫ÁΩÆ‰∏¶Êé®ÈÄÅ Docker Êò†ÂÉèÊ™î
- name: "gcr.io/cloud-builders/docker"
  id: "docker-build-push"
  dir: "test-project/test-server"
  args:
    - "build"
    - "-t"
    - "${_IMAGE_PATH}:${SHORT_SHA}"
    - "-t"
    - "${_IMAGE_PATH}:latest"
    - "."

# 2) Êé®ÈÄÅÊò†ÂÉèÊ™îÂà∞ Artifact Registry
- name: "gcr.io/cloud-builders/docker"
  id: "docker-push"
  args:
    - "push"
    - "${_IMAGE_PATH}:${SHORT_SHA}"

- name: "gcr.io/cloud-builders/docker"
  id: "docker-push-latest"
  args:
    - "push"
    - "${_IMAGE_PATH}:latest"

# 3) ÂèñÂæó GKE Âè¢ÈõÜÊÜëË≠â
- name: "gcr.io/google.com/cloudsdktool/cloud-sdk:slim"
  id: "gke-auth"
  entrypoint: bash
  args:
    - "-c"
    - |
      echo "Getting GKE cluster credentials..."
      gcloud container clusters get-credentials ${_CLUSTER_NAME} --region ${_ZONE_NAME}
      echo "Successfully connected to GKE cluster"

# 4) ÈÉ®ÁΩ≤ Kubernetes Ë≥áÊ∫ê
- name: "gcr.io/cloud-builders/kubectl"
  id: "kubectl-apply"
  entrypoint: bash
  args:
    - "-c"
    - |
      echo "=== Kubernetes Deployment ==="
      echo "Deploying with image: ${_IMAGE_PATH}:${SHORT_SHA}"
      
      # ÂàáÊèõÂà∞ k8s ÁõÆÈåÑ
      cd ${_K8S_PATH}
      
      # Âª∫Á´ã namespace
      kubectl apply -f namespace.yaml
      
      # ÊõøÊèõÊâÄÊúâÂèÉÊï∏
      echo "Replacing parameters in Kubernetes manifests..."
      
      # ÊõøÊèõ deployment.yaml
      sed -i "s|REPLACEME_NAMESPACE|${_NAMESPACE_NAME}|g" deployment.yaml
      sed -i "s|REPLACEME_DEPLOYMENT_NAME|${_DEPLOYMENT_NAME}|g" deployment.yaml
      sed -i "s|REPLACEME_APP_LABEL|${_APP_LABEL}|g" deployment.yaml
      sed -i "s|REPLACEME_REPLICAS|${_REPLICAS}|g" deployment.yaml
      sed -i "s|REPLACEME_MAX_SURGE|${_MAX_SURGE}|g" deployment.yaml
      sed -i "s|REPLACEME_MAX_UNAVAILABLE|${_MAX_UNAVAILABLE}|g" deployment.yaml
      sed -i "s|REPLACEME_CONTAINER_PORT|${_CONTAINER_PORT}|g" deployment.yaml
      sed -i "s|REPLACEME_INITIAL_DELAY_SECONDS|${_INITIAL_DELAY_SECONDS}|g" deployment.yaml
      sed -i "s|REPLACEME_PERIOD_SECONDS|${_PERIOD_SECONDS}|g" deployment.yaml
      sed -i "s|REPLACEME_IMAGE|${_IMAGE_PATH}:${SHORT_SHA}|g" deployment.yaml
      
      # ÊõøÊèõ service.yaml
      sed -i "s|REPLACEME_NAMESPACE|${_NAMESPACE_NAME}|g" service.yaml
      sed -i "s|REPLACEME_DEPLOYMENT_NAME|${_DEPLOYMENT_NAME}|g" service.yaml
      sed -i "s|REPLACEME_APP_LABEL|${_APP_LABEL}|g" service.yaml
      sed -i "s|REPLACEME_SERVICE_PORT|${_SERVICE_PORT}|g" service.yaml
      sed -i "s|REPLACEME_CONTAINER_PORT|${_CONTAINER_PORT}|g" service.yaml
      
      # ÈÉ®ÁΩ≤ service Âíå deployment
      kubectl apply -f service.yaml
      kubectl apply -f deployment.yaml
      
      echo "Successfully applied Kubernetes manifests"

# 5) Á≠âÂæÖÈÉ®ÁΩ≤ÂÆåÊàê
- name: "gcr.io/cloud-builders/kubectl"
  id: "rollout-status"
  entrypoint: bash
  args:
    - "-c"
    - |
      echo "Waiting for deployment rollout to complete..."
      kubectl -n ${_NAMESPACE_NAME} rollout status deployment/${_DEPLOYMENT_NAME} --timeout=600s
      
      # Ê™¢Êü• Pod ÁãÄÊÖã
      echo "Checking pod status..."
      kubectl -n ${_NAMESPACE_NAME} get pods -l app=${_APP_LABEL}
      
      echo "Deployment rollout completed successfully"

# 6) È©óË≠âÈÉ®ÁΩ≤
- name: "gcr.io/cloud-builders/kubectl"
  id: "verify-deployment"
  entrypoint: bash
  args:
    - "-c"
    - |
      echo "=== Deployment Verification ==="
      
      # È°ØÁ§∫ deployment ÁãÄÊÖã
      echo "Deployment status:"
      kubectl -n ${_NAMESPACE_NAME} get deployment ${_DEPLOYMENT_NAME} -o wide
      
      # È°ØÁ§∫ service ÁãÄÊÖã
      echo "Service status:"
      kubectl -n ${_NAMESPACE_NAME} get svc ${_DEPLOYMENT_NAME} -o wide
      
      # È°ØÁ§∫ pod ÁãÄÊÖã
      echo "Pod status:"
      kubectl -n ${_NAMESPACE_NAME} get pods -l app=${_APP_LABEL} -o wide
      
      # Ê™¢Êü•ÂÅ•Â∫∑ÁãÄÊÖã
      echo "Checking pod health..."
      
      ready_pods=$$(kubectl -n ${_NAMESPACE_NAME} get pods -l app=${_APP_LABEL} --no-headers 2>/dev/null | grep -c "Running" || echo "0")
      total_pods=$$(kubectl -n ${_NAMESPACE_NAME} get pods -l app=${_APP_LABEL} --no-headers 2>/dev/null | wc -l | tr -d ' ')
      
      echo "Ready pods: $${ready_pods}/$${total_pods}"
      
      if [ "$${ready_pods}" -eq "$${total_pods}" ] && [ "$${total_pods}" -gt 0 ]; then
        echo "‚úÖ All pods are ready and healthy"
      else
        echo "‚ùå Not all pods are ready ($${ready_pods}/$${total_pods})"
        kubectl -n ${_NAMESPACE_NAME} describe pods -l app=${_APP_LABEL}
        exit 1
      fi
      
      echo "üéâ Deployment verification completed successfully!"

